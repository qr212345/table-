<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Â∫ßÂ∏≠„É¨„Ç§„Ç¢„Ç¶„ÉàÁÆ°ÁêÜ</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #layoutArea, #palette { position: relative; width: 100%; height: 100vh; overflow: hidden; }
    .element { position: absolute; cursor: move; border-radius: 6px; user-select: none; }
    .seat { width: 60px; height: 60px; background-color: gray; }
    .used { background-color: red !important; }
    .pillar { width: 40px; height: 40px; background-color: #555; border-radius: 50%; }
    .screen { width: 200px; height: 10px; background-color: black; }
    .entrance { width: 60px; height: 20px; background-color: #888; border: 2px dashed white; }
    #palette { background: #f2f2f2; padding: 10px; display: flex; gap: 10px; border-bottom: 2px solid #ccc; }
    .palette-item { width: 60px; height: 60px; background-color: #ccc; text-align: center; line-height: 60px; cursor: grab; border: 1px solid #999; border-radius: 6px; }
    #saveBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    .rotate-btn, .delete-btn, .resize-handle { position: absolute; width: 20px; height: 20px; background: #fff; border: 1px solid #333; border-radius: 50%; cursor: pointer; font-size: 14px; text-align: center; line-height: 20px; }
    .rotate-btn { top: -10px; right: -10px; }
    .delete-btn { bottom: -10px; right: -10px; }
    .resize-handle { bottom: -10px; left: -10px; cursor: se-resize; }
  </style>
</head>
<body>
  <div id="palette">
    <div class="palette-item" data-type="seat">Â∫ßÂ∏≠</div>
    <div class="palette-item" data-type="pillar">Êü±</div>
    <div class="palette-item" data-type="screen">„Çπ„ÇØ„É™„Éº„É≥</div>
    <div class="palette-item" data-type="entrance">ÂÖ•Âè£</div>
    <button id="saveBtn" disabled>üíæ ‰øùÂ≠ò</button>
  </div>
  <div id="layoutArea"></div>

  <script>
    const layoutArea = document.getElementById("layoutArea");
    const saveBtn = document.getElementById("saveBtn");
    const paletteItems = document.querySelectorAll(".palette-item");
    const GRID_SIZE = 20;
    let layoutData = JSON.parse(localStorage.getItem("layoutData")) || [];
    let isDragging = false, offsetX = 0, offsetY = 0;
    let dragTarget = null;

    function createElement(type, x = 50, y = 50, w = null, h = null, rot = 0) {
      const el = document.createElement("div");
      el.classList.add("element", type);
      el.dataset.type = type;
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      if (w) el.style.width = `${w}px`;
      if (h) el.style.height = `${h}px`;
      if (rot) el.style.transform = `rotate(${rot}deg)`;
      el.appendChild(createButton("üîÑ", "rotate-btn", () => rotateElement(el)));
      el.appendChild(createButton("üóëÔ∏è", "delete-btn", () => deleteElement(el)));
      el.appendChild(createHandle(el));
      layoutArea.appendChild(el);
      enableDrag(el);
    }

    function createButton(text, className, action) {
      const btn = document.createElement("div");
      btn.className = className;
      btn.innerText = text;
      btn.onclick = (e) => { e.stopPropagation(); action(); markChanged(); };
      return btn;
    }

    function createHandle(el) {
      const handle = document.createElement("div");
      handle.className = "resize-handle";
      handle.addEventListener("mousedown", (e) => {
        e.stopPropagation();
        let startX = e.clientX, startY = e.clientY;
        let startW = el.offsetWidth, startH = el.offsetHeight;

        function resizeMove(ev) {
          const newW = Math.max(20, Math.round((startW + ev.clientX - startX) / GRID_SIZE) * GRID_SIZE);
          const newH = Math.max(20, Math.round((startH + ev.clientY - startY) / GRID_SIZE) * GRID_SIZE);
          el.style.width = `${newW}px`;
          el.style.height = `${newH}px`;
        }
        function resizeEnd() {
          document.removeEventListener("mousemove", resizeMove);
          document.removeEventListener("mouseup", resizeEnd);
          markChanged();
        }
        document.addEventListener("mousemove", resizeMove);
        document.addEventListener("mouseup", resizeEnd);
      });
      return handle;
    }

    function enableDrag(el) {
      el.onmousedown = (e) => {
        if (e.target.classList.contains("rotate-btn") || e.target.classList.contains("delete-btn") || e.target.classList.contains("resize-handle")) return;
        isDragging = true;
        dragTarget = el;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      };
    }

    document.onmousemove = (e) => {
      if (!isDragging || !dragTarget) return;
      const x = Math.round((e.clientX - offsetX) / GRID_SIZE) * GRID_SIZE;
      const y = Math.round((e.clientY - offsetY) / GRID_SIZE) * GRID_SIZE;
      dragTarget.style.left = `${x}px`;
      dragTarget.style.top = `${y}px`;
    };

    document.onmouseup = () => {
      if (isDragging) markChanged();
      isDragging = false;
      dragTarget = null;
    };

    function rotateElement(el) {
      const current = el.style.transform.match(/rotate\((\d+)deg\)/);
      const angle = current ? parseInt(current[1]) : 0;
      el.style.transform = `rotate(${(angle + 90) % 360}deg)`;
    }

    function deleteElement(el) {
      el.remove();
    }

    paletteItems.forEach(item => {
      item.ondragstart = () => false;
      item.onmousedown = (e) => {
        const type = item.dataset.type;
        createElement(type);
        markChanged();
      };
    });

    function markChanged() {
      saveBtn.disabled = false;
    }

    saveBtn.onclick = () => {
      const elements = document.querySelectorAll(".element");
      layoutData = Array.from(elements).map(el => ({
        type: el.dataset.type,
        x: parseInt(el.style.left),
        y: parseInt(el.style.top),
        w: el.offsetWidth,
        h: el.offsetHeight,
        rot: el.style.transform.match(/rotate\((\d+)deg\)/)?.[1] || 0
      }));
      localStorage.setItem("layoutData", JSON.stringify(layoutData));
      saveBtn.disabled = true;
    };

    layoutData.forEach(d => createElement(d.type, d.x, d.y, d.w, d.h, d.rot));
  </script>
</body>
</html>
