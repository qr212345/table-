<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>座席レイアウト管理</title>
  <style>
    /* 基本 */
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f0f0f0;
      color: #222;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }
    /* ダークモード */
    body.dark {
      background-color: #121212;
      color: #eee;
    }

    /* ヘッダー */
    #header {
      padding: 10px 15px;
      background: #333;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    #header.dark {
      background: #222;
    }

    #header > div,
    #header select,
    #header button,
    #header input[type=password] {
      font-size: 16px;
      border-radius: 4px;
      border: none;
      padding: 6px 12px;
      box-sizing: border-box;
    }
    #header select {
      min-width: 120px;
      cursor: pointer;
    }
    #header button {
      cursor: pointer;
      background-color: #0078d7;
      color: white;
      transition: background-color 0.2s;
    }
    #header button:hover {
      background-color: #005ea3;
    }
    #header input[type=password] {
      width: 160px;
      outline: none;
      border: 1px solid #999;
      color: #333;
    }
    body.dark #header input[type=password] {
      background: #333;
      color: #eee;
      border-color: #555;
    }

    /* レイアウトエリア */
    #layoutArea {
      position: relative;
      width: 100vw;
      flex-grow: 1;
      background-color: #fff;
      overflow: auto;
      padding: 10px;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      transition: background-color 0.3s;
      outline: none;
    }
    body.dark #layoutArea {
      background-color: #222;
    }

    /* テーブル */
    .table {
      position: absolute;
      background-color: gray;
      border: 2px solid black;
      border-radius: 6px;
      text-align: center;
      padding: 10px;
      box-sizing: border-box;
      touch-action: none;
      color: white;
      font-weight: 600;
      user-select: none;
      cursor: default;
      transition: background-color 0.3s, border-color 0.3s;
    }
    body.dark .table {
      border-color: #ccc;
      color: #eee;
    }
    .table.used {
      background-color: #c0392b !important;
      border-color: #e74c3c !important;
    }
    body.dark .table.used {
      background-color: #e74c3c !important;
      border-color: #f1948a !important;
    }

    /* リサイズハンドル */
    .resize-handle {
      position: absolute;
      width: 14px;
      height: 14px;
      background: black;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      border-radius: 2px;
      opacity: 0.6;
      transition: background-color 0.2s;
    }
    .resize-handle:hover {
      background: #0078d7;
    }
    body.dark .resize-handle {
      background: #eee;
      opacity: 0.7;
    }
    body.dark .resize-handle:hover {
      background: #4aa3ff;
    }

    /* 管理モード時のテーブルのカーソル */
    .table.admin {
      cursor: move;
      box-shadow: 0 0 6px 2px #0078d7aa;
      border-color: #0078d7;
    }
    /* フォーカススタイル */
    .table:focus {
      outline: 3px solid #0078d7;
      z-index: 10;
    }

    /* 編集履歴ログ */
#logArea {
  height: 120px;
  background: #eee;
  font-family: monospace;
  font-size: 12px;
  color: #111;
  overflow-y: auto;
  padding: 8px;
  border-top: 1px solid #ccc;
  user-select: text;
  transition: background-color 0.3s, color 0.3s;
  display: none; /* ← 追加：初期は非表示 */
}
body.dark #logArea {
  background: #121212;
  color: #eee;
  border-color: #444;
}


    /* スマホ対応 */
    @media (max-width: 768px) {
      #header {
        font-size: 14px;
        gap: 5px;
      }
      #header > div,
      #header select,
      #header button,
      #header input[type=password] {
        font-size: 14px;
        padding: 5px 8px;
      }
      .table {
        font-size: 12px;
        padding: 6px;
      }
      .resize-handle {
        width: 12px;
        height: 12px;
      }
    }
  </style>
</head>
<body class="light">
  <div id="header" class="light" role="banner">
    <div>
      <button id="toggleAdminBtn" aria-pressed="false" aria-label="管理モード切替">管理モード OFF</button>
      <input type="password" id="adminPass" placeholder="パスワード" aria-label="管理モードパスワード" autocomplete="off" />
      <button id="addTableBtn" style="display:none;" aria-label="座席を追加">＋座席追加</button>
    </div>
    <select id="roomSelect" aria-label="部屋選択">
      <option value="room1">Room 1</option>
      <option value="room2">Room 2</option>
    </select>
    <button id="themeToggleBtn" aria-label="テーマ切り替え">ダークモード</button>
  </div>
  <main id="layoutArea" tabindex="0" aria-live="polite" aria-label="座席レイアウト"></main>
  <aside id="logArea" aria-live="polite" aria-label="編集履歴ログ" role="log"></aside>

  <script>
    const ADMIN_PASSWORD = "babanuki123";
    const SYNC_ENDPOINT = "https://script.google.com/macros/s/AKfycbzdn68UJbzKkXZiUJex2fDhGDJp8eniFab-K9MN6zYkBxEPwASUPzTDYlHVVFmk4DA/exec";
    let isAdmin = false;
    let currentRoom = localStorage.getItem("currentRoom") || "room1";
    let dragging = null;
    let resizing = null;
    let offsetX = 0, offsetY = 0;
    let autoSaveTimer = null;
    let layoutData = JSON.parse(localStorage.getItem("layoutData") || "[]");

    // ログ追加
    function addLog(text) {
      const logArea = document.getElementById("logArea");
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      logArea.textContent = `[${timeStr}] ${text}\n` + logArea.textContent;
    }

    // 管理モード切替
    document.getElementById("toggleAdminBtn").addEventListener("click", () => {
      const passInput = document.getElementById("adminPass");
      if (passInput.value === ADMIN_PASSWORD) {
        isAdmin = !isAdmin;
        passInput.value = "";
        document.getElementById("toggleAdminBtn").textContent = `管理モード ${isAdmin ? "ON" : "OFF"}`;
        document.getElementById("toggleAdminBtn").setAttribute("aria-pressed", isAdmin.toString());
        addLog(`管理モードが${isAdmin ? "ON" : "OFF"}に切り替わりました`);
        document.getElementById("addTableBtn").style.display = isAdmin ? "inline-block" : "none";
        
        document.getElementById("logArea").style.display = isAdmin ? "block" : "none";
        
        renderLayout();
      } else {
        alert("パスワードが違います");
      }
    });

    // 座席追加
    document.getElementById("addTableBtn").addEventListener("click", () => {
      const newId = `table_${Date.now()}`;
      const newTable = {
        id: newId,
        tableId: newId,
        label: `座席 ${layoutData.filter(t => t.room === currentRoom).length + 1}`,
        x: 20,
        y: 20,
        width: 80,
        height: 80,
        room: currentRoom,
        used: false
      };
      layoutData.push(newTable);
      addLog(`新しい座席「${newTable.label}」を追加しました`);
      renderLayout();
      markChanged();
    });

    // 部屋切替
    const roomSelect = document.getElementById("roomSelect");
    roomSelect.value = currentRoom;
    roomSelect.addEventListener("change", e => {
      currentRoom = e.target.value;
      localStorage.setItem("currentRoom", currentRoom);
      addLog(`部屋が "${currentRoom}" に切り替わりました`);
      renderLayout();
    });

    // テーマ切替
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    themeToggleBtn.addEventListener("click", () => {
      const body = document.body;
      if(body.classList.contains("light")){
        body.classList.replace("light", "dark");
        themeToggleBtn.textContent = "ライトモード";
        document.getElementById("header").classList.replace("light", "dark");
        localStorage.setItem("theme", "dark");
        addLog("テーマをダークモードに切り替えました");
      } else {
        body.classList.replace("dark", "light");
        themeToggleBtn.textContent = "ダークモード";
        document.getElementById("header").classList.replace("dark", "light");
        localStorage.setItem("theme", "light");
        addLog("テーマをライトモードに切り替えました");
      }
    });

    // テーブル生成
function createTable(table) {
  const div = document.createElement("div");
  div.className = "table" + (isAdmin ? " admin" : "");
  div.style.left = table.x + "px";
  div.style.top = table.y + "px";
  div.style.width = table.width + "px";
  div.style.height = table.height + "px";
  div.textContent = table.label || table.tableId || "Table";
  div.dataset.id = table.id;
  if (table.used) div.classList.add("used");
  div.setAttribute("tabindex", "0");
  div.setAttribute("role", "button");
  div.setAttribute("aria-label", `${table.label || table.tableId}${table.used ? " 使用中" : " 空き"}`);

  if (isAdmin) {
    div.addEventListener("mousedown", dragStart);
    const resizer = document.createElement("div");
    resizer.className = "resize-handle";
    resizer.addEventListener("mousedown", resizeStart);
    div.appendChild(resizer);
    
    // キーボードで移動・削除操作用イベント追加
    div.addEventListener("keydown", tableKeyDown);
    
    // マウス削除ボタン追加
    const delBtn = document.createElement("button");
    delBtn.textContent = "✖";
    delBtn.setAttribute("aria-label", "座席を削除");
    delBtn.style.position = "absolute";
    delBtn.style.top = "2px";
    delBtn.style.right = "2px";
    delBtn.style.background = "rgba(255, 0, 0, 0.8)";
    delBtn.style.color = "white";
    delBtn.style.border = "none";
    delBtn.style.borderRadius = "50%";
    delBtn.style.width = "20px";
    delBtn.style.height = "20px";
    delBtn.style.cursor = "pointer";
    delBtn.style.fontWeight = "bold";
    delBtn.style.lineHeight = "18px";
    delBtn.style.padding = "0";
    delBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // ドラッグと衝突しないように
      if (confirm(`座席「${table.label}」を削除しますか？`)) {
        layoutData = layoutData.filter(t => t.id !== table.id);
        addLog(`座席「${table.label}」を削除しました`);
        renderLayout();
        markChanged();
      }
    });
    div.appendChild(delBtn);
  }

  return div;
}


    // ドラッグ開始
    function dragStart(e) {
      if(!isAdmin) return;
      if(e.target.classList.contains("resize-handle")) return;
      dragging = e.currentTarget;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
      window.addEventListener("mousemove", dragMove);
      window.addEventListener("mouseup", dragEnd);
      e.preventDefault();
    }
    function dragMove(e) {
      if (!dragging) return;
      dragging.style.left = (e.pageX - offsetX) + "px";
      dragging.style.top = (e.pageY - offsetY) + "px";
      e.preventDefault();
    }
    function dragEnd() {
      if (!dragging) return;
      const id = dragging.dataset.id;
      const table = layoutData.find(t => t.id == id);
      if(table){
        table.x = parseInt(dragging.style.left);
        table.y = parseInt(dragging.style.top);
        markChanged(`座席 ${table.label || table.tableId} を移動しました`);
      }
      dragging = null;
      window.removeEventListener("mousemove", dragMove);
      window.removeEventListener("mouseup", dragEnd);
    }

    // リサイズ開始
    function resizeStart(e) {
      if(!isAdmin) return;
      resizing = e.currentTarget.parentElement;
      offsetX = e.clientX;
      offsetY = e.clientY;
      window.addEventListener("mousemove", resizeMove);
      window.addEventListener("mouseup", resizeEnd);
      e.stopPropagation();
      e.preventDefault();
    }
    function resizeMove(e) {
      if (!resizing) return;
      let newW = resizing.offsetWidth + (e.clientX - offsetX);
      let newH = resizing.offsetHeight + (e.clientY - offsetY);
      newW = Math.max(newW, 40);
      newH = Math.max(newH, 40);
      resizing.style.width = newW + "px";
      resizing.style.height = newH + "px";
      offsetX = e.clientX;
      offsetY = e.clientY;
      e.preventDefault();
    }
    function resizeEnd() {
      if (!resizing) return;
      const id = resizing.dataset.id;
      const table = layoutData.find(t => t.id == id);
      if(table){
        table.width = parseInt(resizing.style.width);
        table.height = parseInt(resizing.style.height);
        markChanged(`座席 ${table.label || table.tableId} をリサイズしました`);
      }
      resizing = null;
      window.removeEventListener("mousemove", resizeMove);
      window.removeEventListener("mouseup", resizeEnd);
    }

    // キーボード操作で移動・削除
// キーボード操作で移動・削除
function tableKeyDown(e) {
  // 管理モードでなければ何もしない
  if (!isAdmin) return;

  const div = e.currentTarget;
  const step = 10;
  let left = parseInt(div.style.left);
  let top = parseInt(div.style.top);
  let changed = false;

  switch (e.key) {
    case "ArrowLeft":
      div.style.left = Math.max(0, left - step) + "px";
      changed = true;
      break;
    case "ArrowRight":
      div.style.left = left + step + "px";
      changed = true;
      break;
    case "ArrowUp":
      div.style.top = Math.max(0, top - step) + "px";
      changed = true;
      break;
    case "ArrowDown":
      div.style.top = top + step + "px";
      changed = true;
      break;
    case "Delete":
    case "Backspace":
      if (confirm(`座席「${div.textContent}」を削除しますか？`)) {
        const id = div.dataset.id;
        layoutData = layoutData.filter(t => t.id !== id);
        addLog(`座席「${div.textContent}」を削除しました`);
        renderLayout();
        markChanged();
      }
      break;
  }

  if (changed) {
    const id = div.dataset.id;
    const table = layoutData.find(t => t.id == id);
    if (table) {
      table.x = parseInt(div.style.left);
      table.y = parseInt(div.style.top);
      markChanged(`座席 ${table.label || table.tableId} をキーボードで移動しました`);
    }
    e.preventDefault();
  }
}


    // レイアウトレンダリング
    function renderLayout() {
      const area = document.getElementById("layoutArea");
      area.innerHTML = "";
      layoutData.filter(t => t.room === currentRoom).forEach(table => {
        area.appendChild(createTable(table));
      });
    }

    // 変更マーク＆自動保存
    function markChanged(logText) {
      addLog(logText || "変更がありました");
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        saveLayout();
        addLog("自動保存されました");
      }, 1000);
    }

    // 保存
    function saveLayout() {
      localStorage.setItem("layoutData", JSON.stringify(layoutData)); // ローカルにも保存

      fetch(SYNC_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },  // ← ここをapplication/jsonからtext/plainへ変更
        body: JSON.stringify(layoutData)
      })
      .then(res => res.text())
      .then(msg => addLog("🌐 同期サーバーに保存しました: " + msg))
      .catch(err => {
        console.error(err);
        addLog("❌ 同期保存に失敗しました");
      });
    }


    // 外部データを反映してusageを更新する（GAS連携想定）
    function updateTableUsage(usedTables) {
      let updated = false;
      layoutData.forEach(table => {
        const shouldBeUsed = usedTables.includes(table.tableId || table.id);
        if(table.used !== shouldBeUsed){
          table.used = shouldBeUsed;
          updated = true;
        }
      });
      if(updated){
        renderLayout();
        addLog("使用状況を更新しました");
      }
    }

    // 外部GASデータ読み込み（例）
    function loadExternalUsageData() {
  fetch("https://script.google.com/macros/s/AKfycbzPUOz4eCsZ7RVm4Yf_VPu1OC5nn2yIOPa5U-tT7ZMHpw0FRNsHaqovbX7vSaEHjPc/exec")
    .then(res => res.json())
    .then(data => {
      const usedTableIds = Object.keys(data.tables || {}); // 例: { table1: {...}, table2: {...} }
      updateTableUsage(usedTableIds);
      addLog("✅ 外部データの読み込みに成功しました"); // ← 成功メッセージ
    })
    .catch(() => addLog("❌ 外部データの読み込みに失敗しました"));
}


    // 初期化
    window.addEventListener("load", () => {
      document.getElementById("roomSelect").value = currentRoom;
      renderLayout();
      loadExternalUsageData();

      setInterval(loadExternalUsageData, 10000); // 10秒ごとにGASからデータ取得
     // 一定間隔で同期サーバーから最新データを取得し、自動で更新
      setInterval(() => {
        fetch(SYNC_ENDPOINT)
        .then(res => res.json())
        .then(data => {
      // 現在の layoutData と比較し、違いがあれば更新
       if (JSON.stringify(data) !== JSON.stringify(layoutData)) {
        layoutData = data;
        renderLayout();
        addLog("🔄 同期サーバーから最新の座席レイアウトを反映しました");
       }
      })
        .catch(err => {
        console.error(err);
        addLog("❌ 同期チェックに失敗しました");
      });
      }, 10000); // ← 10秒ごとに同期チェック（必要なら時間変更OK）

      // テーマ保存復元
      const savedTheme = localStorage.getItem("theme") || "light";
      if(savedTheme === "dark"){
        document.body.classList.replace("light", "dark");
        themeToggleBtn.textContent = "ライトモード";
        document.getElementById("header").classList.replace("light", "dark");
      } else {
        document.body.classList.replace("dark", "light");
        themeToggleBtn.textContent = "ダークモード";
        document.getElementById("header").classList.replace("dark", "light");
      }
    });

    // ページ離脱前に保存
    window.addEventListener("beforeunload", () => {
      saveLayout();
    });
  </script>
</body>
</html>
