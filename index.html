<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº§å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç†</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f0f0;
    }
    #toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      background: #fff;
      border-bottom: 1px solid #ccc;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #toolbar button, #toolbar select {
      padding: 6px 10px;
      font-size: 14px;
    }
    #layoutArea {
      position: relative;
      width: 100%;
      height: calc(100vh - 60px);
      background: white;
      overflow: auto;
    }
    .item {
      position: absolute;
      border: 2px solid gray;
      background: #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      user-select: none;
    }
    .table {
      background: lightgray;
      width: 80px;
      height: 80px;
    }
    .used {
      background: #f55 !important;
    }
    .entrance {
      width: 60px;
      height: 10px;
      background: #333;
    }
    .screen {
      width: 120px;
      height: 10px;
      background: #222;
    }
    .pillar {
      width: 20px;
      height: 20px;
      background: #999;
      border-radius: 4px;
    }
    .delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: red;
      color: white;
      text-align: center;
      font-size: 14px;
      line-height: 20px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
    }
    .resizer {
      width: 10px;
      height: 10px;
      background: #666;
      position: absolute;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      border-radius: 2px;
    }
    .item.admin .delete-btn,
    .item.admin .resizer {
      display: block;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button onclick="toggleAdmin()">ğŸ”’ ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</button>
    <select id="palette">
      <option value="table">åº§å¸­</option>
      <option value="pillar">æŸ±</option>
      <option value="entrance">å…¥å£</option>
      <option value="screen">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³</option>
    </select>
    <button onclick="addElement()">ï¼‹è¿½åŠ </button>
    <button id="saveBtn" onclick="saveLayout()" disabled>ğŸ’¾ ä¿å­˜</button>
  </div>
  <div id="layoutArea"></div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbza3MwtSu_QCN_ZZKg7BnkBtUL3wTaZmtkRgymRGv-7PQnsd6piwbxmMu_uOZGfvfA/exec";
    let isAdmin = false;
    let draggedItem = null;
    let offsetX = 0, offsetY = 0;
    const layoutArea = document.getElementById("layoutArea");
    const saveBtn = document.getElementById("saveBtn");

    function toggleAdmin() {
      isAdmin = !isAdmin;
      document.querySelectorAll(".item").forEach(el => {
        if (isAdmin) el.classList.add("admin");
        else el.classList.remove("admin");
      });
    }

    function addElement() {
      const type = document.getElementById("palette").value;
      const div = document.createElement("div");
      div.className = `item ${type}`;
      div.style.left = "20px";
      div.style.top = "20px";
      div.setAttribute("data-id", `item_${Date.now()}`);

      const del = document.createElement("div");
      del.className = "delete-btn";
      del.innerText = "Ã—";
      del.onclick = () => { div.remove(); markChanged(); };
      div.appendChild(del);

      const resizer = document.createElement("div");
      resizer.className = "resizer";
      div.appendChild(resizer);

      addDrag(div);
      addResize(div, resizer);
      layoutArea.appendChild(div);
      markChanged();
    }

    function addDrag(el) {
      el.addEventListener("mousedown", e => {
        if (!isAdmin) return;
        if (e.target.classList.contains("resizer") || e.target.classList.contains("delete-btn")) return;
        draggedItem = el;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });
    }

    function addResize(el, handle) {
      handle.addEventListener("mousedown", e => {
        if (!isAdmin) return;
        e.stopPropagation();
        let startX = e.clientX;
        let startY = e.clientY;
        let startW = el.offsetWidth;
        let startH = el.offsetHeight;

        function resizeMove(ev) {
          const newW = Math.max(20, startW + ev.clientX - startX);
          const newH = Math.max(20, startH + ev.clientY - startY);
          el.style.width = newW + "px";
          el.style.height = newH + "px";
        }

        function stop() {
          document.removeEventListener("mousemove", resizeMove);
          document.removeEventListener("mouseup", stop);
          markChanged();
        }

        document.addEventListener("mousemove", resizeMove);
        document.addEventListener("mouseup", stop);
      });
    }

    document.addEventListener("mousemove", e => {
      if (!draggedItem) return;
      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;
      // ã‚¹ãƒŠãƒƒãƒ—ï¼ˆ10pxå˜ä½ï¼‰
      draggedItem.style.left = Math.round(x / 10) * 10 + "px";
      draggedItem.style.top = Math.round(y / 10) * 10 + "px";
    });

    document.addEventListener("mouseup", () => {
      if (draggedItem) markChanged();
      draggedItem = null;
    });

    function markChanged() {
      saveBtn.disabled = false;
    }

function saveLayout() {
  const items = Array.from(document.querySelectorAll(".item"));
  const layout = items.map(el => ({
    tableID: el.dataset.id,
    x: parseInt(el.style.left),
    y: parseInt(el.style.top),
    playerIds: []  // å¿…è¦ã«å¿œã˜ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å«ã‚ã¦ãã ã•ã„
  }));

  const params = new URLSearchParams();
  params.append("mode", "save");
  params.append("layoutData", JSON.stringify(layout));
  params.append("operator", "webUser");

  fetch(GAS_URL + "?" + params.toString(), {
    method: "GET",
  })
    .then(res => res.text())
    .then(msg => {
      alert("ä¿å­˜ã—ã¾ã—ãŸ: " + msg);
      saveBtn.disabled = true;
    })
    .catch(err => {
      console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", err);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
    });
}

async function loadLayout() {
  try {
    const res = await fetch(GAS_URL);  // æ—¢ã«GETãªã®ã§ãã®ã¾ã¾ã§OK
    const json = await res.json();
    const tables = json.tables || [];

    layoutArea.innerHTML = "";  // å‰ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢

    for (const tbl of tables) {
      const div = document.createElement("div");
      div.className = `item table`;
      div.style.left = tbl.x + "px";
      div.style.top = tbl.y + "px";
      div.style.width = (tbl.w || 80) + "px";
      div.style.height = (tbl.h || 80) + "px";
      div.dataset.id = tbl.tableID;

      if (tbl.playerIds && tbl.playerIds.length > 0) {
        div.classList.add("used");
      }

      const del = document.createElement("div");
      del.className = "delete-btn";
      del.innerText = "Ã—";
      del.onclick = () => { div.remove(); markChanged(); };
      div.appendChild(del);

      const resizer = document.createElement("div");
      resizer.className = "resizer";
      div.appendChild(resizer);

      layoutArea.appendChild(div);
      addDrag(div);
      addResize(div, resizer);
    }
  } catch (err) {
    console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
  }
}


    loadLayout();
  </script>
</body>
</html>
